{% load i18n %}
{% load static %}
{% load bootstrap3 %}
<p>{% blocktrans trimmed %}
    Please click on Pay with Sumup {{ nonce }}
    {% endblocktrans %}</p>
<div id="sumup-card"></div>

<script type="text/javascript" nonce="{{ nonce }}" src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>

<script type="text/javascript" nonce="{{ nonce }}">
    /* Â© Ronan LE MEILlAT 2023 */
    let sumupCard; // will host Sumup widget
    
    function waitForElm(selector) {
        return new Promise(resolve => {
            if (document.querySelector(selector)) {
                return resolve(document.querySelector(selector));
            }

            const observer = new MutationObserver(mutations => {
                if (document.querySelector(selector)) {
                    resolve(document.querySelector(selector));
                    observer.disconnect();
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    }

    function insertAfter(referenceNode, newNode) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    waitForElm('button[type="submit"]').then((submitElm) => {
        submitElm.classList.add('hidden');
        submitElm.disabled = true;
        // let btnPay = _button = document.createElement("button");
        // btnPay.innerHTML = "Pay with Sumup";
        // btnPay.classList.add('btn', 'btn-block', 'btn-primary', 'btn-lg');
        // btnPay.addEventListener('click', function (event) {
        //     SumUpCard.submit();
        // }); 
        //insertAfter(submitElm, btnPay);
        sumupCard = SumUpCard.mount({
            id: 'sumup-card',
            nonce: "{{ nonce }}",
            checkoutId: "{{sumupCheckout.id}}",
            onResponse: function (type, body) {
                console.log('Type', type);
                console.log('Body', body);
                if (type == "success") {
                    sumupCard.unmount();
                    submitElm.classList.remove('hidden');
                    submitElm.disabled = false;
                    submitElm.innerHTML = "Payment OK, get your ticket";
                }
            }
        });
    })


</script>